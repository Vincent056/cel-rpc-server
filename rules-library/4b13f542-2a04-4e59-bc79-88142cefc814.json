{
  "id":  "4b13f542-2a04-4e59-bc79-88142cefc814",
  "name":  "Restrict VNC Access to Authorized Users via RBAC",
  "description":  "This rule ensures that RoleBindings only grant VNC access ('token.kubevirt.io:generate' on 'virtualmachineinstances/vnc') if the associated Role explicitly allows it within the same namespace. This restricts VNC access to only those users who have been authorized through a properly scoped Role, following least-privilege and namespace separation best practices. Any RoleBinding referencing a Role for VNC access must have a corresponding Role with the precise permissions.",
  "expression":  "rolebindings.items.all(rb, !rb.roleRef.name.matches('.*vnc.*') || roles.items.exists(r, r.metadata.name == rb.roleRef.name && r.metadata.namespace == rb.metadata.namespace && r.rules.exists(rule, rule.resources.exists(res, res == 'virtualmachineinstances/vnc') && rule.verbs.exists(v, v == 'token.kubevirt.io:generate'))))",
  "inputs":  [
    {
      "name":  "rolebindings",
      "kubernetes":  {
        "group":  "rbac.authorization.k8s.io",
        "version":  "v1",
        "resource":  "rolebindings"
      }
    },
    {
      "name":  "roles",
      "kubernetes":  {
        "group":  "rbac.authorization.k8s.io",
        "version":  "v1",
        "resource":  "roles"
      }
    }
  ],
  "tags":  [
    "generated",
    "ai-assisted"
  ],
  "category":  "security",
  "severity":  "medium",
  "test_cases":  [
    {
      "id":  "test-1",
      "name":  "Valid - Authorized VNC RoleBinding and Role",
      "description":  "A RoleBinding exists referencing a Role that explicitly allows VNC token generation in the same namespace.",
      "test_data":  {
        "rolebindings":  "{\"items\":[{\"metadata\":{\"name\":\"vnc-access\",\"namespace\":\"vmspace\"},\"roleRef\":{\"kind\":\"Role\",\"name\":\"vnc-role\"}}]}",
        "roles":  "{\"items\":[{\"metadata\":{\"name\":\"vnc-role\",\"namespace\":\"vmspace\"},\"rules\":[{\"resources\":[\"virtualmachineinstances/vnc\"],\"verbs\":[\"token.kubevirt.io:generate\"]}]}]}"
      },
      "expected_result":  true
    },
    {
      "id":  "test-2",
      "name":  "Invalid - RoleBinding references Role without VNC permission",
      "description":  "A RoleBinding references a Role in the same namespace, but the Role does not permit VNC token generation.",
      "test_data":  {
        "rolebindings":  "{\"items\":[{\"metadata\":{\"name\":\"vnc-access\",\"namespace\":\"vmspace\"},\"roleRef\":{\"kind\":\"Role\",\"name\":\"vnc-role\"}}]}",
        "roles":  "{\"items\":[{\"metadata\":{\"name\":\"vnc-role\",\"namespace\":\"vmspace\"},\"rules\":[{\"resources\":[\"virtualmachineinstances/vnc\"],\"verbs\":[\"get\"]}]}]}"
      }
    },
    {
      "id":  "test-3",
      "name":  "Valid - No VNC-related RoleBindings",
      "description":  "All RoleBindings reference Roles unrelated to VNC access.",
      "test_data":  {
        "rolebindings":  "{\"items\":[{\"metadata\":{\"name\":\"view\",\"namespace\":\"default\"},\"roleRef\":{\"kind\":\"Role\",\"name\":\"view\"}}]}",
        "roles":  "{\"items\":[{\"metadata\":{\"name\":\"view\",\"namespace\":\"default\"},\"rules\":[{\"resources\":[\"pods\"],\"verbs\":[\"get\",\"list\"]}]}]}"
      },
      "expected_result":  true
    },
    {
      "id":  "test-4",
      "name":  "Invalid - RoleBinding references Role in different namespace",
      "description":  "A RoleBinding references a Role with VNC permissions, but the Role is not in the same namespace.",
      "test_data":  {
        "rolebindings":  "{\"items\":[{\"metadata\":{\"name\":\"vnc-access\",\"namespace\":\"vmspace\"},\"roleRef\":{\"kind\":\"Role\",\"name\":\"vnc-role\"}}]}",
        "roles":  "{\"items\":[{\"metadata\":{\"name\":\"vnc-role\",\"namespace\":\"other-namespace\"},\"rules\":[{\"resources\":[\"virtualmachineinstances/vnc\"],\"verbs\":[\"token.kubevirt.io:generate\"]}]}]}"
      }
    },
    {
      "id":  "test-5",
      "name":  "Edge Case - Empty lists",
      "description":  "No RoleBindings or Roles are present.",
      "test_data":  {
        "rolebindings":  "{\"items\":[]}",
        "roles":  "{\"items\":[]}"
      },
      "expected_result":  true
    }
  ],
  "metadata":  {
    "platforms":  [
      "kubernetes"
    ]
  },
  "created_at":  "1754594181",
  "updated_at":  "1754594181",
  "created_by":  "chat-ui",
  "last_modified_by":  "chat-ui"
}